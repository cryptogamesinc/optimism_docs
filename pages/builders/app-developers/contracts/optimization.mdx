---
title: OPメインネット上でのコントラクト最適化
lang: ja-JP
description: OPメインネットでコントラクトを最適化する方法と、それを行う際に注意すべき点を学びます。
---

import { Callout } from 'nextra/components'

# OPメインネット上でのコントラクト最適化

OPメインネットは[EVM equivalent](https://web.archive.org/web/20231127160757/https://medium.com/ethereum-optimism/introducing-evm-equivalence-5c2021deb306)と設計されており、可能な限りEthereumと全く同じように見えるようになっています。
しかし、OPメインネットとEthereumの間には、避けられない大きな違いが一つあります。それは[取引手数料モデルの違い](/stack/transactions/fees)です。
この違いにより、OPメインネットのコントラクトを最適化し、OPメインネットの手数料モデルをより有効に活用する機会が生まれます。

このガイドでは、OPメインネットのコントラクトを最適化するための基本的な概念を説明し、これらの概念を活用するいくつかの例を提供します。
また、潜在的なコントラクト最適化に関連するトレードオフとリスクについてもより良く理解できます。
このガイドを終えた時には、OPメインネットのコントラクトをどのように最適化できるか、そしてそれらの最適化があなたのアプリケーションにとって意味があるかどうかを明確に理解できるはずです。

<Callout>
コントラクトの最適化は強力ですが、追加の複雑性を生じさせることもあります。
最適化の種類によっては、OPメインネットが進化するにつれて不要になる可能性もあります。
最適化を進める前に、このページのすべての考慮事項をよく読んでください。
</Callout>

## 基本

アプリ開発者は、スマートコントラクトとのやり取りのコストを減らすための[gas optimization](https://www.alchemy.com/overviews/solidity-gas-optimization)の概念にすでに精通しているかもしれません。
ガスの最適化により、コントラクトが使用するガスの量を減らすことができ、アプリケーションを安くすることができます（これによりユーザーエクスペリエンスが向上します）。

OPメインネットのコントラクトも、Ethereum上のコントラクトと同様に、全体的な取引コストを削減するためにガス最適化が可能です。
ただし、OPメインネットの取引は、Ethereumへのトランザクションデータの公開コストをカバーするための別の料金であるL1 Data Feeも支払う必要があります。
このガイドが書かれた時点では、このL1 Data FeeがOPメインネットのほとんどの取引のコストの大部分を占めています。

L1 Data Feeが実行ガス料金よりも大きい傾向にあるため、**OPメインネットのコントラクトは、各取引でユーザーが提供するデータの量を減らすことで、ストレージ/実行の使用量を増やすことによってさらに最適化が可能です。**
これが、OPメインネットのコントラクト最適化がEthereumとは少し異なる基本的な前提です。

## 考慮事項

### 追加の複雑性

コントラクトの最適化は追加の複雑性を生じさせ、それによって追加のリスクも生じます。
開発者は、この追加の複雑性がコスト削減のメリットに値するかどうか常に考慮する必要があります。

### 経済の変化

OPメインネットへの様々な潜在的なアップグレードによって、L1 Data Feeの最適化の関連性が低下する可能性もあります。
たとえば、[EIP-4844](https://www.eip4844.com/)が採用された場合、Ethereumへのデータの公開コストを大幅に削減するため、L1 Data Feeも減少します。

OPメインネットはまた、チェーン使用が増加すると基本料金を自動的に増加させる[EIP-1559](https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1559.md)メカニズムを使用しています。
L1 Data Feeを減らすための最適化は、基本料金が取引コストの大部分を占めるようになると、関連性が低くなるかもしれません。

<Callout>
一般的に言って、**開発者はL1 Data Feeの最適化が時間が経つにつれて役に立たなくなると考えるべきです。**
もし契約が長期間使用されることを期待する場合、長期的なガス効率を低下させる可能性のある最適化を避けることを検討するかもしれません。
もし契約が短期間で主に使用されることを期待している、または将来契約をアップグレードする能力がある場合、最適化はより適しているかもしれません。
</Callout>

## 技術

### Calldata圧縮

ユーザーデータをクライアント側で圧縮し、契約側で展開することは、OPメインネット上でコストを減らす効果的な方法です。
この技術は、ユーザーが提供するデータの量を減らす代わりに、オンチェーン計算を大幅に増やします。

このcalldata圧縮を行うためのいくつかのライブラリが存在しますが、このページの執筆時点でどのライブラリも監査されていません。
そのため、開発者がバグのあるソフトウェアを使用することを奨励しないように、ここではこれらのライブラリへのリンクは意図的に省略されています。
これらのライブラリのほとんどはオンラインで簡単に見つかりますが、インターネット上で見つかるコードには常に注意してください。

### カスタムエンコーディング

[Solidity ABIエンコーディングスキーム](https://docs.soliditylang.org/en/v0.8.23/abi-spec.html#argument-encoding)は特にデータ効率が良いわけではありません。
契約は、カスタム引数エンコーディングプロトコルを定義することによって、提供されるcalldataの量をしばしば減らすことができます。

カスタム引数エンコーディングは、保存されたデータと組み合わせることで、さらにコストを削減することができます。
たとえば、`address`引数は、`uint64 => address`の保存されたマッピングでルックアップを実行する`uint64`ポインターに置き換えることができます。
これにより、トータルで必要なアドレスの数が少ない場合（`uint64`を`uint32`やそれ以下に減らすことが可能な場合）、さらに多くのバイト数をカットできます。

カスタムエンコーディングは、一般的なcalldata圧縮ライブラリよりは複雑性が低いことが多いですが、どんな場合でも追加の複雑性を伴います。
アプリケーション固有のカスタムエンコーディングは、一般的な圧縮メカニズムよりもはるかに効率的です。
